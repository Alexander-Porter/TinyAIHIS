# 混合关键词+向量检索实现文档

## 功能概述

本次更新实现了基于 Lucene 10.3.2 的混合关键词+向量检索系统，并集成了 Function Call RAG 支持和医生工作站的全局划词查询功能。

## 主要功能

### 1. 混合检索系统

结合了传统关键词检索和向量语义检索的优势：

- **关键词检索**：使用 Lucene 的 SmartChineseAnalyzer 进行中文分词和全文检索
- **向量检索**：使用 HNSW 算法进行高效的向量相似度搜索
- **混合评分**：可配置的权重组合（默认 30% 关键词 + 70% 向量）

### 2. Function Call RAG

AI 助手在调用知识库时会显示：
- 调用的工具名称
- 查询参数
- 检索到的知识来源（疾病名称和科室）

### 3. 全局划词查询

医生工作站支持：
- 选中任意文本后右键搜索知识库
- 查看详细的疾病信息
- 一键引用到病历中

## 配置说明

### application.properties 配置项

```properties
# 知识库路径
medical.knowledge.path=file:./medical-knowledge/

# 向量索引路径
medical.knowledge.vector-path=file:./vector-index/

# 混合检索关键词权重 (0.0-1.0, 默认 0.3)
medical.search.keyword-weight=0.3

# 嵌入模型配置
siliconflow.embedding.model=BAAI/bge-m3
siliconflow.embedding.url=https://api.siliconflow.cn/v1/embeddings
SILICONFLOW_API_KEY=你的API密钥
```

## 索引字段说明

### 文本检索字段
| 字段名 | 类型 | 用途 | 权重 |
|--------|------|------|------|
| disease_text | TextField | 疾病名称检索 | 3.0 |
| symptoms | TextField | 症状检索 | 2.0 |
| diagnosis | TextField | 诊断检索 | 1.5 |
| treatment | TextField | 治疗方案检索 | 1.2 |
| department_text | TextField | 科室检索 | 1.0 |
| causes | TextField | 病因检索 | 1.0 |
| prevention | TextField | 预防措施检索 | 0.8 |
| content | TextField | 通用内容检索 | 0.5 |

### 存储字段
- `id`: 文档唯一标识
- `diseaseName`: 疾病名称（用于显示）
- `department`: 所属科室（用于显示）

### 向量字段
- `embedding`: 1024 维向量（使用 BAAI/bge-m3 模型）

## API 接口

### 1. AI 导诊（流式）

**端点**: `POST /api/triage/stream`

**请求体**:
```json
{
  "description": "头痛、发烧",
  "bodyPart": "头部"
}
```

**响应**: SSE 流式事件
- `status`: 状态消息
- `tool_call`: 工具调用信息（JSON）
- `tool`: 工具使用简述
- `thought`: AI 思考过程
- `message`: AI 回复内容
- `result`: 最终推荐结果

### 2. AI 医生助手（流式）

**端点**: `POST /api/triage/doctor-assist`

**请求体**:
```json
{
  "content": "患者咳嗽加重，是否需要调整用药？",
  "patientId": 123,
  "conversationId": "uuid-string"
}
```

**响应**: SSE 流式事件（同上）

### 3. 知识库搜索

**端点**: `POST /api/triage/search-knowledge`

**请求体**:
```json
{
  "query": "糖尿病治疗",
  "limit": 5
}
```

**响应**:
```json
{
  "success": true,
  "data": [
    {
      "id": "001_糖尿病.json",
      "diseaseName": "糖尿病",
      "department": "内分泌科",
      "content": "..."
    }
  ]
}
```

## 前端使用说明

### 1. AI 对话中查看知识来源

在 AI 导诊或医生助手对话中，当 AI 使用知识库时会显示：

```
┌─────────────────────────────────┐
│ 🔧 调用工具: search_knowledge_base │
├─────────────────────────────────┤
│ 查询: 头痛发烧                    │
│ 检索结果:                         │
│ 📄 感冒 [呼吸内科]               │
│ 📄 流感 [呼吸内科]               │
│ 📄 脑膜炎 [神经内科]             │
└─────────────────────────────────┘
```

### 2. 全局划词搜索

在医生工作站的任意位置：

1. 选中文本（如"糖尿病"、"高血压"等）
2. 右键点击选中的文本
3. 点击"搜索知识库"
4. 在弹出的对话框中查看搜索结果
5. 点击"引用到病历"可将知识插入病历

## 性能优化建议

### 1. 索引优化
- 定期清理无效文档
- 合并索引段以提高查询性能
- 考虑使用 RAMDirectory 缓存热点数据

### 2. 缓存策略
- 使用 Redis 缓存热门查询结果
- 实现查询结果的 LRU 缓存
- 缓存向量嵌入结果

### 3. 批量处理
- 批量索引文档以提高效率
- 异步处理向量嵌入任务
- 使用连接池管理 HTTP 请求

## 故障排查

### 问题 1: 中文搜索结果不准确

**原因**: SmartChineseAnalyzer 未正确初始化

**解决方案**:
1. 检查 Lucene 依赖版本是否一致
2. 确认 lucene-analysis-smartcn 已正确引入
3. 重建索引

### 问题 2: 向量搜索返回空结果

**原因**: API 密钥未配置或向量未嵌入

**解决方案**:
1. 检查 `SILICONFLOW_API_KEY` 环境变量
2. 查看日志确认嵌入是否成功
3. 手动触发重建索引：访问管理后台

### 问题 3: 前端不显示工具调用信息

**原因**: SSE 事件解析错误或事件类型不匹配

**解决方案**:
1. 打开浏览器开发者工具查看网络请求
2. 检查 SSE 事件流格式
3. 确认前端事件处理器正确注册

## 扩展开发

### 添加新的索引字段

1. 在 `MedicalKnowledgeBase.indexJsonFields()` 中添加字段映射
2. 在 `keywordSearch()` 中配置字段权重
3. 重建索引

### 自定义混合检索权重

通过配置文件调整：

```properties
medical.search.keyword-weight=0.5  # 50% 关键词 + 50% 向量
```

或在代码中调用：

```java
knowledgeBase.hybridSearch(query, topK, 0.5f);
```

### 集成其他嵌入模型

修改配置：

```properties
siliconflow.embedding.model=your-model-name
siliconflow.embedding.url=your-api-endpoint
```

## 测试用例

### 关键词搜索测试

```java
// 测试中文分词
List<MedicalDocument> results = knowledgeBase.search("糖尿病", 5);

// 测试症状匹配
results = knowledgeBase.search("头痛 发烧 咳嗽", 5);

// 测试科室匹配
results = knowledgeBase.search("呼吸内科", 5);
```

### 混合搜索测试

```java
// 纯关键词搜索
results = knowledgeBase.hybridSearch("高血压", 5, 1.0f);

// 纯向量搜索
results = knowledgeBase.hybridSearch("经常头晕、心慌", 5, 0.0f);

// 混合搜索
results = knowledgeBase.hybridSearch("糖尿病并发症", 5, 0.3f);
```

## 参考资料

- [Apache Lucene 10.3.2 文档](https://lucene.apache.org/core/10_3_2/index.html)
- [SmartChineseAnalyzer 使用指南](https://lucene.apache.org/core/10_3_2/analysis/smartcn/index.html)
- [HNSW 算法原理](https://arxiv.org/abs/1603.09320)
- [RAG 系统设计最佳实践](https://www.pinecone.io/learn/retrieval-augmented-generation/)

## 更新日志

### v1.0.0 (2025-12-07)

**新增功能**:
- ✅ 混合关键词+向量检索系统
- ✅ Function Call RAG 支持
- ✅ 全局划词查询功能
- ✅ 知识来源可视化展示

**技术改进**:
- ✅ 升级 Lucene 到 10.3.2
- ✅ 添加 SmartChineseAnalyzer 支持
- ✅ 实现可配置的混合检索权重
- ✅ 添加请求 DTO 提高类型安全

**Bug 修复**:
- ✅ 修复 Lucene 版本不一致问题
- ✅ 优化中文分词效果

## 联系方式

如有问题或建议，请通过以下方式联系：

- GitHub Issues: [TinyHIS Issues](https://github.com/Alexander-Porter/TinyHIS/issues)
- 邮箱: support@tinyhis.com

---

© 2025 TinyHIS Team. All rights reserved.
